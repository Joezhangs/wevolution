1引言
1.1编写目的
1.1.1明确软件的详细设计内容，以便于下一步的编码实现。
1.1.2本文档的读者对象为：项目设计人员、项目开发人员。
1.2项目背景
项目来源
本项目来源于北京天德科技有限公司的私有区块链项目。私有区块链是一种访问权限控制较为严格的区块链系统，具有高效、安全等特性，可应用到信用卡交易、虚拟货币等各个场景中。私有区块链使用去中心化的分布式框架，每秒处理数据量在万级以上。私有区块链本身只运行在系统的各个数据处理节点后台，没有可视化界面进行数据查询与访问。作为一个对可用性和可靠性要求较高的系统，其数据处理效率，各个数据处理节点的运转情况、信誉情况等都需要进行实时监控，以保证私有区块链的正常运行。私有区块链配有监控系统后，节点问题能够被迅速发现，通过人工修复，私有区块链系统能够及时地恢复正常运行。
本文介绍了一种面向私有区块链的监控系统的整体框架及工作流程。监控系统采用Thrift软件框架作为各个节点之间的通信框架，利用其高效的特点保证数据传输的实时性。使用基于内存的高速日志型数据库Redis来应对大量实时监控数据的处理与存储。各个数据处理节点部署相应的客户端监控程序，进行实时的系统性能数据及区块链处理能力数据的采集，并发送给监控系统的后台服务器端；监控系统后台服务器端接收到各个客户端发来的数据消息，对数据进行分析后存入Redis缓存。前台页面显示监控数据时，调用后台相应的接口，从服务器端的Redis数据库中获取监控数据。
主管部门
北京天德科技有限公司
1.3术语定义
SDK
Software Development Kit软件开发包。
1.4参考资料
[1] WIKIPEDIA. Blockchain(database)[EB/OL]. https://en.wikipedia.org/wiki/Blockchain_(database)
[2] 巴比特. 区块链是什么[EB/OL]. http://www.8btc.com/what-is-blockchain.
[3] Apache Software Foundation. Apache Thrift[EB/OL]. http://thrift.apache.org/.
[4] Redis中文网. Redis[EB/OL]. http://www.redis.net.cn/.



2总体设计
2.1需求概述
通过使用互联网与区块链等新技术，建设一个具有系统管理、用户管理、IP版权登记确权、版权交易和孵化（后期）功能的IP区块链平台。IP区块链的版权登记采用区块链技术，从根本上实现弱中心化的版权登记，让区块链中的参与者在无需建立信任关系的前提下实现一个统一的账本系统。IP区块链平台以区块链为技术核心，利用其防篡改、不可逆、可靠性、可信任、分布式、公开透明等特性，采用多节点构成，节点和节点之间采用共识算法，保证一致性，避免拜占庭问题，利用一旦记录完成就会永远存在并且无法更改这一系列特性，实现IP确权维权，以及为后续各种IP内容的孵化与交易提供保障。
为了保障建设质量，建议平台建设采用分期分步骤实施，第一期IP区块链平台主要完成平台设计与搭建、版权登记确权、版权证书制作及版权信息查询等功能，主要功能如下：
	功能
序号	功能模块	描述
1	首页	网站首页，包括：
（1）平台名称+Slogan(平台标语)
（2）IP版权确权入口
（3）IP版权展示以及交易入口
（4）登陆、注册入口
（5）经典案例展示入口
（6）网络文学小说IP展示界面入口
（7）公司简介入口
（8）行业资讯动态展示
（9）推荐阅读资讯
（10）搜索栏
（11）网页最下方：展示公司合作平台、平台备案等信息


2	注册	平台用户注册
3	登录	注册用户使用手机动态密码登录与密码登录，包括第三方如微信、微博及支付宝登录
4	找回密码	当注册用户忘记注册设置的密码时，可以通过用户手机号验证完成密码重设
5	手机短信接口	手机短信及验证接口集成
6	实名认证	包括个人用户实名认证与企业用户实名认证
7	版权登记-作品文件上传	将需要做版权登记的作品文件上传至服务器
8	版权登记-作品信息	将需要做版权登记的作品信息，如作品名称、作品类别、作品创作性质、创作完成日期、创作完成地点、发表状态等信息进行登记
9	版权登记-作者及著作权信息、作品样本	将需要版权登记作品的作者及著作权信息、作品样本等信息进行登记
10	系统管理	建立后台管理员各种权限角色，对登记的作品进行查询、审核
11	版权登记-审核查询列表	查询待审核的版权登记列表
12	版权登记-审核接口	审核版权登记作品
13	用户管理-个人资料维护	查询及修改用户相关信息
14	用户管理-版权确权查询	查询用户版权确权作品列表
15	制作版权证书	生成用户版权确权证书
16	查询版权证书	查询用户版权确权证书
17	下载版权证书	下载用户版权确权证书
18	-经典IP作品版权及相应案例展示	经典IP版权作品分类展示：版权展示、往期应用案例展示（针对网络文学IP需单独设计展示页面）
19	版权作品查询-平台内作品查询 	版权作品查询-
平台内IP作品
20	区块链版权确权区块统计与查询	区块链版权确权区块统计与查询


2.2区块链应用架构图










包含IP区块链应用系统和私有区块链系统。前端实时通信，接收各个区块链节点发来的统计数据，并在本地进行存储。当前台节点发来数据访问请求时，后台节点将会把本地的数据发送给前台节点。监控前台为监控系统的前端服务器，它向监控后台节点服务器发起请求，获取数据后进行数据的展示。区块链节点与监控后台节点双向通信，使用client-server结构。监控前台与监控后台单向通信，获取展示数据。
2.3区块链监控系统组件分布设计

区块链监控系统组件分布示意图
区块链节点中原有的区块链组件未进行修改，保留原有的设计与实现，在此基础上，区块链节点上增加了数据收集的组件。数据收集组件与区块链组件部署在同一节点服务器上，使用相同数据库进行数据访问。数据收集组件通过访问区块链组件使用的数据库，来收集区块链的处理能力信息，并将区块链节点的状态信息一起发送至监控的后台节点。监控后台节点的数据收集存储组件用于接收从区块链节点的数据收集组件发来的统计信息，将这些信息存储到监控后台节点的本地数据库中。同时，监控后台节点的Web接口组件用于向前台提供接口。监控前台的UI组件调用后台的Web访问接口，获取数据并在前台页面上进行展示。
2.4区块链监控系统逻辑分层设计

区块链监控系统逻辑分层示意图
监控系统主要与数据存储层进行数据交互。监控系统数据收集层从私有区块链系统的数据存储层获得节点数据和区块链数据。节点数据包含节点的性能数据以及节点的信誉数据，区块链数据则包含交易和块的一些生成统计数据。数据收集层与数据统计层使用通信框架进行高速的数据交互。数据统计层将获得的统计数据存入缓存中。当数据展示层发起请求时，返回相应的数据在界面上进行展示。数据展示层主要包括了区块链整体的数据信息展示以及各个节点的详细信息展示。
2.5区块链监控系统技术栈设计

区块链监控系统技术栈示意图
私有区块链系统主要使用SpringBoot架构，运用Reactor框架进行异步处理，为了提高可复用性，交易信息或状态信息使用JSON格式数据进行临时存储，区块链节点间使用REST进行通信，处理完的交易数据或状态数据以及区块数据存储到MySQL数据库中。监控系统同样使用SpringBoot和Reactor架构，数据收集层通过JDBC和Mybatis访问底层MySQL数据库，同时从Redis中获取必须的信息。数据收集层与数据统计层之间使用Thrift进行高速通信。数据统计层将收集到的数据转换为JSON格式数据存储在本地的Redis数据库中，同时提供REST接口供前台页面进行调用访问。数据展示层使用NodeJS搭建前台页面，实现界面样式。
2.6区块链监控系统模块设计
如图所示，私有区块链系统与监控系统整体分为七大模块。bc-web模块为监控前台节点需要部署的前台UI部分。bc-monitor实现监控后台收集数据以及向前台提供展示内容的功能。bc-collection实现区块链节点及处理能力数据的收集功能。这三个模块组成监控系统的主体，模块间的关系可以简述为，bc-web调用bc-monitor的接口，bc-monitor与bc-collection之前进行通信，完成数据的传输。私有区块链部分，bc-smartcontract为区块链顶层的智能合约应用，在智能合约的处理过程中，bc-smartcontract将把状态数据发送至状态区块链，将交易数据发送至交易区块链分别进行验证与存储。bc-state和bc-transaction分别为状态区块链和交易区块链的实现模块，这两个模块除了具体操作的数据对象有所区别，验证和存储流程基本一致。为了提高复用，区块链的验证与存储流程被提取至公共的底层模块bc-core中。bc-core模块封装了区块链的主体流程以及一些公共的方法和配置。除bc-web前台模块自称一体，未依赖bc-core模块外，其他模块都使用了相同的底层依赖，即bc-core模块。


区块链监控系统模块示意图
2.7区块链监控系统节点通信设计
数据收集节点与监控后台之间的通信使用Thrift框架完成。
监控后台节点上部署bc-monitor模块，模块内实现了Thrift server的搭建。Thrift Server使用高效密集的二进制传输协议TCompactProtocol作为节点间的传输协议。服务器端类型选择了多线程服务器端使用标准的阻塞式I/O——TThreadPoolServer。
区块链节点的数据收集组件，对应bc-collection模块，实现了Thrift client的搭建。Thrift client使用了与Thrift server一致的传输协议TCompactProtocol。传输层使用了阻塞式I/O传输TSocket。
服务端程序ThriftServer启动时，首先实例化服务端的TServerTransport对象，指定Thrift服务的IP和端口。MonitorRPC为thrift脚本生成的Thrift服务类，与选用的传输协议TCompactProtocol一同作为服务端类型对象实例化的参数传入其构造方法。
Thrift服务器构造完毕后，调用TThreadPoolServer的serve方法，启动Thrift服务，服务器进入监听状态，阻塞在accept方法上。Thrift客户端主动发起通信，并将消息发送后，Thrift服务器将新建一个线程运行WorkerProcess来进行消息的处理。新线程获取到服务端使用的传输协议TCompactProtocol与MonitorRPC中定义的Processor，通过Processor调用TCompactProtocol读取消息数据。消息读取开始后，服务端调用Thrift服务类MonitorRPC中定义的参数获取方法和read方法进行读取，并将结果写入结果。下图所示为ThriftServer启动的过程以及服务的响应过程。

ThriftServer启动与服务响应时序图
客户端启动时，首先实例化传输层对象TSocket，指定通信服务端的IP和端口后打开传输。使用TCompactProtocol传输协议创建客户端实例。客户端调用sendData方法，传递调用send_sendData方法写入消息，发送对服务端的调用请求，通过 recv_sendData方法读取服务端处理请求后返回的方法结果。

ThriftClient调用服务过程时序图
2.8区块链监控系统前端页面设计
监控系统前台功能使用NodeJS技术实现。监控页面不断刷新，发送数据请求，以显示实时信息。
前台页面包含两个一级目录，其一显示节点的处理能力信息，其二显示节点的信誉与负载信息。第一个一级目录包含区块链系统整体处理能力的展示，各个节点的实时运行状态，同时也提供分节点进行统计信息查看的功能。下含两个子链接，其一链接到区块链的整体监控信息界面，其二链接到节点状态列表，显示区块链系统的所有节点及状态信息。同时，节点列表中的每一项都设置了链接，点击后可进入各个节点的详细信息页面，展示节点自己的监控信息。第二个二级目录下设两个子链接，第一个链接可跳转至区块链系统整体信誉值展示页面，第二个链接可跳转至区块链系统的节点性能信息截面，每个节点一个柱形图，显示CPU使用率、内存使用率、磁盘使用率信息，所有节点在同一界面上展示。
页面所有展示的信息均为动态获取，实时更新。页面示例见下图。

监控前台总体页面示意图
监控前台节点详细页面示意图

监控前台负载页面示意图



3程序描述
3.1功能
3.1.1区块链节点运行状态监控
私有区块链各个节点以每秒1万左右的交易处理效率对交易进行验证与存储，由于私有区块链的节点数量不多，每一个节点的故障都有可能导致区块链系统停运，因为在进行验证或存储时，节点有可能无法达到拜占庭将军算法所要求的能够达到共识的节点数量。监控系统可以实时观察到各个区块链处理节点运行状态，通过不同的标识来区分正常的区块链节点和异常的区块链节点。一旦发现节点故障，迅速通过人工干预修复节点，以恢复和保证私有区块链的正常运行。因此，节点的正常运行和节点故障要能够迅速地反映到监控系统的前后台中。
3.1.2区块链节点性能监控
由于私有区块链具有较高的交易处理速度，低配置的系统可能无法支持区块链系统的正常运转，因此，区块链节点的性能指标也是我们需要关注的问题。内存是否够用，CPU使用率是否过高，磁盘是否已满等，都需要监控系统来进行实时监控。因此，监控系统提供了区块链节点的性能监控功能，主要监控对象其一是CPU的使用率，其二是内存使用率，最后是磁盘空间的使用率。
3.1.3区块链节点信誉值监控
区块链系统开始运行时，每个节点初始信誉值默认设置为0.6，表示该节点是可以被信任的。在交易处理的过程中，使用拜占庭将军算法作为共识进行交易和块的验证。如果某一个节点处理和验证的结果与其他节点不同，那么这个节点有可能发生了故障，或者是受到了恶意的攻击或数据篡改，此时该节点能够被区块链系统识别出来，并将其信誉值降为0。运行正常的节点则会在每次建块成功后小幅度提升自己的信誉值。因此，信誉值对于监控节点是否遭受恶意攻击或运算规则是否出错具有积极意义。监控系统提供了各个节点信誉值的实时展示功能。
3.1.4区块链节点平均处理能力监控
除了上述区块链节点的运行状态与性能监控外，监控系统还提供了对区块链数据处理能力的监控功能。正常情况下的私有区块链系统，每秒可以处理上万条交易，且各个节点的统计数据应该相似。如果某个节点的交易处理能力数据与其他节点差距较大，则可能是区块链系统出现了问题，可能会发生交易或区块的缺失。
区块链系统接收交易，对交易进行验证处理后创建区块，交易和区块数据最终都会存储在节点的数据库中。监控系统对区块链节点处理能力的监控主要是对区块链的交易处理能力和区块处理能力进行分析与记录。监控系统从多角度出发对数据库数据进行了分析与处理，包括单位时间内数据的处理数量、单位区块相关数据统计、总体数量统计等。对单位时间内数据处理数量的监控包括每小时创建区块数量和每小时处理交易个数两项指标。每小时创建区块数量与每小时处理交易数量保留了近12小时的统计数据，可以直观的看到区块和交易处理能力的变化。对单位区块相关数据统计监控主要是平均建块消耗时间的计算，以及平均每个区块包含交易数量的统计，有助于私有区块链系统的性能分析。总体数量统计功能包含两项，最近一小时交易量和总区块数量。 
3.1.5区块链整体状态与单独节点状态的监控
监控系统提供了两个层面的监控功能，对区块链系统的节点状态和处理能力进行了展示。在前文提到的四个监控系统的主要功能中，节点的运行状态与节点性能监控这两项是对区块链系统整体的监控，能够同时看到区块链系统中所有处理节点的节点信息。区块链节点信誉值与区块链节点平均处理能力这两个监控功能，既可以展示整个区块链系统的平均数值，也可以对各个节点的具体情况进行分别的查看。
3.2性能
主要性能	主要要求
正确性	功能运行正确性不小于99%。
数据统计结果正确性要求100%。
健壮性	软件要求程序代码有必要的运行时错误处理机制，避免由于运行时错误导致软件无响应或非正常退出等异常现象。
性能，效率	节点状态同步延迟小于5秒；
数据统计更新频率小于5秒；
复杂数据计算和显示时间小于1秒。
易用性	界面展示简介明了，菜单文字意义明确。
安全性	对用户身份进行必要的认证，密码要求密文保存、星号显示和输入。

3.3输入项目
私有区块链系统
3.4输出项目
 私有区块链监控系统
3.5接口
3.5.1节点性能
名称：getLoad
URL：http://[IP]:[PORT]/getLoad
返回值：各节点性能数据
返回值示例：
{ 
" http://127.0.0.2:8080": "{
    \"Mem\": \"85.63852005987214%\",
    \"CPU\": \"12.1%\",
    \"Disk\": \"54.62180316950642%\"
}",
"http: //127.0.0.1: 8080": "{
    \"Mem\": \"83.17846382338494%\",
    \"CPU\": \"1.5%\",
    \"Disk\": \"54.62172059119044%\"
}" 
}
JAVA接口：public Map<String, String> getLoad()
3.5.2节点信誉值
名称：getNodeCredit
URL：http://[IP]:[PORT]/getNodeCredit?ip=[value]
返回值：各节点信誉值，包含每个节点返回的其本地储存的多个节点的信誉值
返回值示例：
{"node1":"0.6862398","node2":"8080"}
JAVA接口：public Map<String, String> getNodeCredit()
3.5.3区块平均创建用时
名称：avgGenerateTime
URL：http://[IP]:[PORT]/avgGenerateTime?ip=[value]
返回值：各节点平局建块时间
返回值示例：5.15
JAVA接口：public Map<String, String> getAvgGenerateTime()
3.5.4平均块大小
名称：avgBlockSize
URL：http://[IP]:[PORT]/avgBlockSize?ip=[value] 
返回值：各节点平均每块中包含的交易数量
返回值示例：0.7500
JAVA接口：public Map<String, String> getAvgTxLength()
3.5.5最近一小时交易量
名称：getRecentTransList
URL：http://[IP]:[PORT]/getRecentTransList?ip=[value]
返回值：各节点最近10个区域块id及包含的交易数量
返回值示例：
[
    {
        "id": 8,
        "tx_lenth": 1
    },
    {
        "id": 7,
        "tx_lenth": 1
    },
    {
        "id": 6,
        "tx_lenth": 1
    },
    {
        "id": 5,
        "tx_lenth": 1
    },
    {
        "id": 4,
        "tx_lenth": 1
    },
    {
        "id": 3,
        "tx_lenth": 1
    },
    {
        "id": 2,
        "tx_lenth": 0
    },
    {
        "id": 1,
        "tx_lenth": 0
    }
]
JAVA接口：public Map<String, String> getRecentTransList()
3.5.6总区块数量
名称：getBlockNum
URL：http://[IP]:[PORT]/getBlockNum?ip=[value] 
返回值：各节点块数量
返回值示例：14
JAVA接口：public Map<String, String> getBlockNum()
3.5.7每小时创建区块数量
名称：getBlockCountHourly
URL：http://[IP]:[PORT]/getBlockCountHourly?ip=[value]
返回值：每小时建块数量，统计了近12小时的数值
返回值示例：[0,0,0,0,0,0,0,0,0,0,0,14]
JAVA接口：public Map<String, String> getBlockCountHourly()
3.5.8每小时交易处理量
名称：getTxLengthCountHourly
URL：http://[IP]:[PORT]/getTxLengthCountHourly?ip=[value]
返回值：每小时交易数量，统计了近12小时的数值
返回值示例：[0,0,0,0,0,0,0,0,0,0,0,14]
JAVA接口：public Map<String, String> getTxLengthCountHourly()
3.5.9节点运行状态
名称：nodes
URL：http://[IP]:[PORT]/nodes
返回值：各节点ip、name、status对照表
返回值示例：
[
    {
        "ip": "http://127.0.0.1:8080",
        "name": "node1",
        "status": "1"
    },
    {
        "ip": "http://127.0.0.2:8080",
        "name": "node2",
        "status": "0"
    }
]
JAVA接口：public Map<String, String> getNodes()
3.6限制条件
开发限制
基于Java语言和SQL语言开发。
软硬件环境
需求名称	详细要求
硬件要求	至少四台64位Linux服务器
内存32G或以上
硬盘空间200G或以上
软件要求	操作系统CentOS Release 6.5 (Final)以上
Java SDK 1.8或以上
Redis 3.2.4或以上
MySQL 5.6或以上
