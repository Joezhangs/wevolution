IP数据化及资产证券化的区块链应用
====
# 1.引言
----
## 1.1编写目的
明确软件的详细设计内容，以便于下一步的编码实现。
<br>本文档的读者对象为：项目设计人员、项目开发人员。
## 1.2项目背景
### 项目来源
> 本项目来源于北京天德科技有限公司的私有区块链项目。私有区块链是一种访问权限控制较为严格的区块链系统，
<br>具有高效、安全等特性，可应用到信用卡交易、虚拟货币等各个场景中。私有区块链使用去中心化的分布式
<br>框架，每秒处理数据量在万级以上。私有区块链本身只运行在系统的各个数据处理节点后台，没有可视化界
<br>面进行数据查询与访问。作为一个对可用性和可靠性要求较高的系统，其数据处理效率，各个数据处理节点
<br>的运转情况、信誉情况等都需要进行实时监控，以保证私有区块链的正常运行。私有区块链配有监控系统后，
<br>节点问题能够被迅速发现，通过人工修复，私有区块链系统能够及时地恢复正常运行。<br>
> 本文介绍了一种面向私有区块链的监控系统的整体框架及工作流程。监控系统采用Thrift软件框架作为各个
<br>节点之间的通信框架，利用其高效的特点保证数据传输的实时性。使用基于内存的高速日志型数据库Redis来
<br>应对大量实时监控数据的处理与存储。各个数据处理节点部署相应的客户端监控程序，进行实时的系统性能数
<br>据及区块链处理能力数据的采集，并发送给监控系统的后台服务器端；监控系统后台服务器端接收到各个客户
<br>端发来的数据消息，对数据进行分析后存入Redis缓存。前台页面显示监控数据时，调用后台相应的接口，从
<br>服务器端的Redis数据库中获取监控数据。
### 主管部门
北京天德科技有限公司
## 1.3术语定义
### SDK
Software Development Kit软件开发包。
## 1.4参考资料
[1] WIKIPEDIA. Blockchain(database)[EB/OL]. https://en.wikipedia.org/wiki/Blockchain_(database)<br>
[2] 巴比特. 区块链是什么[EB/OL]. http://www.8btc.com/what-is-blockchain.<br>
a)Apache Software Foundation. Apache Thrift[EB/OL]. http://thrift.apache.org/.<br>
[3] Redis中文网. Redis[EB/OL]. http://www.redis.net.cn/.
# 2.总体设计
----
## 2.1需求概述
通过使用互联网与区块链等新技术，建设一个具有系统管理、用户管理、IP版权登记确权、版权交易和孵化（后期）功能<br>
的IP区块链平台。IP区块链的版权登记采用区块链技术，从根本上实现弱中心化的版权登记，让区块链中的参与者在无需<br>
建立信任关系的前提下实现一个统一的账本系统。IP区块链平台以区块链为技术核心，利用其防篡改、不可逆、可靠性、<br>
可信任、分布式、公开透明等特性，采用多节点构成，节点和节点之间采用共识算法，保证一致性，避免拜占庭问题，利用<br>
一旦记录完成就会永远存在并且无法更改这一系列特性，实现IP确权维权，以及为后续各种IP内容的孵化与交易提供保障。
## 2.2区块链应用架构图
![](https://github.com/Joezhangs/wevolution/blob/master/%E5%9B%BE%E7%89%871.png)
包含IP区块链应用系统和私有区块链系统。前端实时通信，接收各个区块链节点发来的统计数据，并在本地进行存储。当前<br>
台节点发来数据访问请求时，后台节点将会把本地的数据发送给前台节点。监控前台为监控系统的前端服务器，它向监控后<br>
台节点服务器发起请求，获取数据后进行数据的展示。区块链节点与监控后台节点双向通信，使用client-server结构。监<br>
控前台与监控后台单向通信，获取展示数据。
## 2.3区块链监控系统组件分布设计
![](https://github.com/Joezhangs/wevolution/blob/master/%E5%9B%BE%E7%89%872.png)
区块链节点中原有的区块链组件未进行修改，保留原有的设计与实现，在此基础上，区块链节点上增加了数据收集的组件。<br>
数据收集组件与区块链组件部署在同一节点服务器上，使用相同数据库进行数据访问。数据收集组件通过访问区块链组件使<br>
用的数据库，来收集区块链的处理能力信息，并将区块链节点的状态信息一起发送至监控的后台节点。监控后台节点的数据<br>
收集存储组件用于接收从区块链节点的数据收集组件发来的统计信息，将这些信息存储到监控后台节点的本地数据库中。同时，<br>
监控后台节点的Web接口组件用于向前台提供接口。监控前台的UI组件调用后台的Web访问接口，获取数据并在前台页面上进行展示。<br>
## 2.4区块链监控系统逻辑分层设计
![](https://github.com/Joezhangs/wevolution/blob/master/%E5%9B%BE%E7%89%873.png)
监控系统主要与数据存储层进行数据交互。监控系统数据收集层从私有区块链系统的数据存储层获得节点数据和区块链数据。<br>
节点数据包含节点的性能数据以及节点的信誉数据，区块链数据则包含交易和块的一些生成统计数据。数据收集层与数据统计<br>
层使用通信框架进行高速的数据交互。数据统计层将获得的统计数据存入缓存中。当数据展示层发起请求时，返回相应的数据<br>
在界面上进行展示。数据展示层主要包括了区块链整体的数据信息展示以及各个节点的详细信息展示。<br>
## 2.5区块链监控系统技术栈设计
![](https://github.com/Joezhangs/wevolution/blob/master/%E5%9B%BE%E7%89%874.png)
私有区块链系统主要使用SpringBoot架构，运用Reactor框架进行异步处理，为了提高可复用性，交易信息或状态信息使用JSON格式<br>
数据进行临时存储，区块链节点间使用REST进行通信，处理完的交易数据或状态数据以及区块数据存储到MySQL数据库中。监控系统同样<br>
使用SpringBoot和Reactor架构，数据收集层通过JDBC和Mybatis访问底层MySQL数据库，同时从Redis中获取必须的信息。数据收集层<br>
与数据统计层之间使用Thrift进行高速通信。数据统计层将收集到的数据转换为JSON格式数据存储在本地的Redis数据库中，同时提供REST<br>
接口供前台页面进行调用访问。数据展示层使用NodeJS搭建前台页面，实现界面样式。
## 2.6区块链监控系统模块设计
如图所示，私有区块链系统与监控系统整体分为七大模块。bc-web模块为监控前台节点需要部署的前台UI部分。bc-monitor实现监控后台<br>
收集数据以及向前台提供展示内容的功能。bc-collection实现区块链节点及处理能力数据的收集功能。这三个模块组成监控系统的主体，<br>
模块间的关系可以简述为，bc-web调用bc-monitor的接口，bc-monitor与bc-collection之前进行通信，完成数据的传输。私有区块链部分，<br>
bc-smartcontract为区块链顶层的智能合约应用，在智能合约的处理过程中，bc-smartcontract将把状态数据发送至状态区块链，将交易数据<br>
发送至交易区块链分别进行验证与存储。bc-state和bc-transaction分别为状态区块链和交易区块链的实现模块，这两个模块除了具体操作的数<br>
据对象有所区别，验证和存储流程基本一致。为了提高复用，区块链的验证与存储流程被提取至公共的底层模块bc-core中。bc-core模块封装了<br>
区块链的主体流程以及一些公共的方法和配置。除bc-web前台模块自称一体，未依赖bc-core模块外，其他模块都使用了相同的底层依赖，即bc-core模块。<br>
![](https://github.com/Joezhangs/wevolution/blob/master/%E5%9B%BE%E7%89%875.png)
## 2.7区块链监控系统节点通信设计
数据收集节点与监控后台之间的通信使用Thrift框架完成。<br>
监控后台节点上部署bc-monitor模块，模块内实现了Thrift server的搭建。Thrift Server使用高效密集的二进制传输协议TCompactProtocol作为节点间的传输协议。服务器端类型选择了多线程服务器端使用标准的阻塞式I/O——TThreadPoolServer。<br>
区块链节点的数据收集组件，对应bc-collection模块，实现了Thrift client的搭建。Thrift client使用了与Thrift server一致的传输协议TCompactProtocol。传输层使用了阻塞式I/O传输TSocket。<br>
服务端程序ThriftServer启动时，首先实例化服务端的TServerTransport对象，指定Thrift服务的IP和端口。MonitorRPC为thrift脚本生成的Thrift服务类，与选用的传输协议TCompactProtocol一同作为服务端类型对象实例化的参数传入其构造方法。<br>
Thrift服务器构造完毕后，调用TThreadPoolServer的serve方法，启动Thrift服务，<br>
服务器进入监听状态，阻塞在accept方法上。Thrift客户端主动发起通信，并将消息发送后，<br>
Thrift服务器将新建一个线程运行WorkerProcess来进行消息的处理。新线程获取到服务端使用的<br>
传输协议TCompactProtocol与MonitorRPC中定义的Processor，通过Processor调用TCompactProtocol读取<br>
消息数据。消息读取开始后，服务端调用Thrift服务类MonitorRPC中定义的参数获取方法和read方法进行读取，<br>
并将结果写入结果。下图所示为ThriftServer启动的过程以及服务的响应过程。<br>
![](https://github.com/Joezhangs/wevolution/blob/master/%E5%9B%BE%E7%89%876.png)
客户端启动时，首先实例化传输层对象TSocket，指定通信服务端的IP和端口后打开传输。<br>
使用TCompactProtocol传输协议创建客户端实例。客户端调用sendData方法，<br>
传递调用send_sendData方法写入消息，发送对服务端的调用请求，通过 recv_sendData方法读取服务端处理请求后返回的方法结果。<br>
![](https://github.com/Joezhangs/wevolution/blob/master/%E5%9B%BE%E7%89%877.png)
## 2.8区块链监控系统前端页面设计
监控系统前台功能使用NodeJS技术实现。监控页面不断刷新，发送数据请求，以显示实时信息。<br>
前台页面包含两个一级目录，其一显示节点的处理能力信息，其二显示节点的信誉与负载信息。<br>
第一个一级目录包含区块链系统整体处理能力的展示，各个节点的实时运行状态，同时也提供分节点<br>
进行统计信息查看的功能。下含两个子链接，其一链接到区块链的整体监控信息界面，其二链接到节点<br>
状态列表，显示区块链系统的所有节点及状态信息。同时，节点列表中的每一项都设置了链接，点击后<br>
可进入各个节点的详细信息页面，展示节点自己的监控信息。第二个二级目录下设两个子链接，第一个<br>
链接可跳转至区块链系统整体信誉值展示页面，第二个链接可跳转至区块链系统的节点性能信息截面，<br>
每个节点一个柱形图，显示CPU使用率、内存使用率、磁盘使用率信息，所有节点在同一界面上展示。<br>
页面所有展示的信息均为动态获取，实时更新。页面示例见下图。
![](https://github.com/Joezhangs/wevolution/blob/master/%E5%9B%BE%E7%89%878.png)<br>
![](https://github.com/Joezhangs/wevolution/blob/master/%E5%9B%BE%E7%89%879.png)<br>
![](https://github.com/Joezhangs/wevolution/blob/master/%E5%9B%BE%E7%89%8710.png)<br>
# 3.程序描述
----
## 3.1功能
### 3.1.1区块链节点运行状态监控
私有区块链各个节点以每秒1万左右的交易处理效率对交易进行验证与存储，由于私有区块链的节点数量不多，<br>
每一个节点的故障都有可能导致区块链系统停运，因为在进行验证或存储时，节点有可能无法达到拜占庭将军算<br>
法所要求的能够达到共识的节点数量。监控系统可以实时观察到各个区块链处理节点运行状态，通过不同的标识来<br>
区分正常的区块链节点和异常的区块链节点。一旦发现节点故障，迅速通过人工干预修复节点，以恢复和保证私有<br>
区块链的正常运行。因此，节点的正常运行和节点故障要能够迅速地反映到监控系统的前后台中。
### 3.1.2区块链节点性能监控
由于私有区块链具有较高的交易处理速度，低配置的系统可能无法支持区块链系统的正常运转，因此，区块链节点<br>
的性能指标也是我们需要关注的问题。内存是否够用，CPU使用率是否过高，磁盘是否已满等，都需要监控系统来<br>
进行实时监控。因此，监控系统提供了区块链节点的性能监控功能，主要监控对象其一是CPU的使用率，其二是内<br>
存使用率，最后是磁盘空间的使用率。
### 3.1.3区块链节点信誉值监控
区块链系统开始运行时，每个节点初始信誉值默认设置为0.6，表示该节点是可以被信任的。在交易处理的过程中，<br>
使用拜占庭将军算法作为共识进行交易和块的验证。如果某一个节点处理和验证的结果与其他节点不同，那么这个<br>
节点有可能发生了故障，或者是受到了恶意的攻击或数据篡改，此时该节点能够被区块链系统识别出来，并将其信誉<br>
值降为0。运行正常的节点则会在每次建块成功后小幅度提升自己的信誉值。因此，信誉值对于监控节点是否遭受恶意<br>
攻击或运算规则是否出错具有积极意义。监控系统提供了各个节点信誉值的实时展示功能。
### 3.1.4区块链节点平均处理能力监控
除了上述区块链节点的运行状态与性能监控外，监控系统还提供了对区块链数据处理能力的监控功能。正常情况下的私有<br>
区块链系统，每秒可以处理上万条交易，且各个节点的统计数据应该相似。如果某个节点的交易处理能力数据与其他节点<br>
差距较大，则可能是区块链系统出现了问题，可能会发生交易或区块的缺失。<br>
区块链系统接收交易，对交易进行验证处理后创建区块，交易和区块数据最终都会存储在节点的数据库中。<br>
监控系统对区块链节点处理能力的监控主要是对区块链的交易处理能力和区块处理能力进行分析与记录。<br>
监控系统从多角度出发对数据库数据进行了分析与处理，包括单位时间内数据的处理数量、单位区块相关数据统计、<br>
总体数量统计等。对单位时间内数据处理数量的监控包括每小时创建区块数量和每小时处理交易个数两项指标。<br>
每小时创建区块数量与每小时处理交易数量保留了近12小时的统计数据，可以直观的看到区块和交易处理能力的变化。<br>
对单位区块相关数据统计监控主要是平均建块消耗时间的计算，以及平均每个区块包含交易数量的统计，有助于私有区块链系统的性能分析。<br>
总体数量统计功能包含两项，最近一小时交易量和总区块数量。 
### 3.1.5区块链整体状态与单独节点状态的监控
监控系统提供了两个层面的监控功能，对区块链系统的节点状态和处理能力进行了展示。在前文提到的四个监控系统的主要功能中，<br>
节点的运行状态与节点性能监控这两项是对区块链系统整体的监控，能够同时看到区块链系统中所有处理节点的节点信息。<br>
区块链节点信誉值与区块链节点平均处理能力这两个监控功能，既可以展示整个区块链系统的平均数值，也可以对各个节点的具体情况进行分别的查看。
